<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u M√£ ƒë·ªÅ - VietNH Startup</title>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* B·ªë c·ª•c t·ªïng th·ªÉ 2 c·ªôt */
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 0; 
            background-color: #f4f6f8; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* ----- C·ªòT B√äN TR√ÅI: SIDEBAR (Ga t√†u) ----- */
        .sidebar { 
            width: 280px; 
            background: white; 
            padding: 40px 20px; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.05); 
            z-index: 10; 
            display: flex;
            flex-direction: column;
        }
        .sidebar h2 { margin-top: 0; color: #333; font-size: 1.2rem; margin-bottom: 30px; padding-left: 15px;}
        
        /* CSS cho Timeline ki·ªÉu ga t√†u */
        .timeline { 
            list-style: none; 
            padding: 0; 
            margin: 0;
            position: relative; 
        }
        /* ƒê∆∞·ªùng ray (V·∫°ch d·ªçc) */
        .timeline::before { 
            content: ''; 
            position: absolute; 
            left: 21px; /* CƒÉn gi·ªØa v√≤ng tr√≤n */
            top: 15px; 
            bottom: 25px; 
            width: 2px; 
            background: #e0e0e0; 
            z-index: 1; 
        }
        /* C√°c tr·∫°m (ƒêi·ªÉm d·ª´ng) */
        .timeline li { 
            position: relative; 
            padding-left: 55px; 
            margin-bottom: 35px; 
            cursor: pointer; 
            font-size: 16px; 
            color: #666; 
            font-weight: 500;
            line-height: 32px; 
            transition: all 0.3s ease; 
        }
        /* V√≤ng tr√≤n c·ªßa t·ª´ng tr·∫°m */
        .timeline li::before { 
            content: ''; 
            position: absolute; 
            left: 12px; 
            top: 6px; 
            width: 16px; 
            height: 16px; 
            border: 2px solid #dc3545; /* M√†u ƒë·ªè nh∆∞ b·∫£n v·∫Ω c·ªßa b·∫°n */
            border-radius: 50%; 
            background: white; 
            z-index: 2; 
            transition: all 0.3s ease; 
        }
        /* Tr·∫°ng th√°i Hover & Active */
        .timeline li:hover { color: #dc3545; }
        .timeline li.active { color: #dc3545; font-weight: bold; }
        .timeline li.active::before { 
            background: #dc3545; 
            box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.2); /* Hi·ªáu ·ª©ng qu·∫ßng s√°ng */
        }

        /* ----- C·ªòT B√äN PH·∫¢I: N·ªòI DUNG ----- */
        .main-content { 
            flex-grow: 1; 
            padding: 40px; 
            overflow-y: auto; 
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* Khung ch·ª©a n·ªôi dung t·ª´ng b∆∞·ªõc */
        .step-section { 
            background: white; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            width: 100%;
            max-width: 700px; 
            display: none; /* ·∫®n ƒëi m·∫∑c ƒë·ªãnh */
            animation: fadeIn 0.4s ease;
        }
        .step-section.active { display: block; } /* Ch·ªâ hi·ªán b∆∞·ªõc ƒëang active */

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Form Controls */
        h3 { margin-top: 0; color: #333; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 25px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"] { 
            padding: 12px; width: 100%; box-sizing: border-box; 
            border: 1px solid #ccc; border-radius: 6px; font-size: 15px;
        }
        input:focus { outline: none; border-color: #0070f3; box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1); }
        
        /* Buttons */
        .btn-primary { padding: 12px 24px; background-color: #0070f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: bold; transition: 0.2s;}
        .btn-primary:hover { background-color: #0051bb; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        .btn-outline { background-color: white; color: #555; border: 1px solid #ccc; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;}
        .btn-outline:hover { background-color: #f0f0f0; }
        
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }

        /* K·∫øt qu·∫£ */
        .success { color: #28a745; background: #e6ffed; border: 1px solid #b7eb8f; padding: 15px; border-radius: 8px; margin-top: 15px;}
        .error { color: #dc3545; background: #fff1f0; border: 1px solid #ffa39e; padding: 15px; border-radius: 8px; margin-top: 15px;}
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Tr·ª£ l√Ω Thi·∫øt k·∫ø M√≥ng ƒê∆°n</h2>
        <ul class="timeline">
            <li id="nav-step-1" class="active" onclick="chuyenBuoc(1)">S·ªë li·ªáu</li>
            <li id="nav-step-2" onclick="chuyenBuoc(2)">Ph∆∞∆°ng √°n m√≥ng</li>
            <li id="nav-step-3" onclick="chuyenBuoc(3)">L·ª±a ch·ªçn k√≠ch th∆∞·ªõc</li>
            <li id="nav-step-4" onclick="chuyenBuoc(4)">Ki·ªÉm tra s·ª©c ch·ªãu t·∫£i</li>
        </ul>
    </div>

    <div class="main-content">
        
        <div id="step-1" class="step-section active">
            <h3>1. Tra c·ª©u ƒë·ªãa ch·∫•t</h3>
            <div class="input-group">
                <label>Nh·∫≠p m√£ ƒë·ªÅ sinh vi√™n:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="maDeInput" placeholder="VD: 2">
                    <button class="btn-primary" style="white-space: nowrap;" onclick="traCuu()">L·∫•y d·ªØ li·ªáu</button>
                </div>
            </div>

            <div id="result"></div>

            <div id="soil-profile-container" style="display:none; margin-top: 30px; text-align: center;">
                <h4 style="margin-bottom: 15px; color: #444;">M√¥ h√¨nh H·ªë khoan</h4>
                <div style="width: 300px; height: 400px; margin: 0 auto;">
                    <canvas id="soilChart"></canvas>
                </div>
            </div>

            <div class="nav-buttons" style="justify-content: flex-end;">
                <button class="btn-primary" onclick="chuyenBuoc(2)" id="btn-next-1" disabled>Ti·∫øp theo &rarr;</button>
            </div>
        </div>

        <div id="step-2" class="step-section">
            <h3>2. L·ª±a ch·ªçn Ph∆∞∆°ng √°n m√≥ng</h3>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">D·ª±a v√†o tr·ª• ƒë·ªãa ch·∫•t ·ªü b∆∞·ªõc tr∆∞·ªõc, h√£y quy·∫øt ƒë·ªãnh ƒë·ªô s√¢u ch√¥n m√≥ng.</p>
            
            <div class="input-group">
                <label>ƒê·ªô s√¢u ch√¥n m√≥ng $D_f$ (m):</label>
                <input type="number" id="inputDf" value="1.5" step="0.1">
            </div>

            <div class="nav-buttons">
                <button class="btn-outline" onclick="chuyenBuoc(1)">&larr; Quay l·∫°i</button>
                <button class="btn-primary" onclick="chuyenBuoc(3)">Ti·∫øp theo &rarr;</button>
            </div>
        </div>

        <div id="step-3" class="step-section">
            <h3>3. L·ª±a ch·ªçn k√≠ch th∆∞·ªõc m√≥ng</h3>
            
            <div class="input-group">
                <label>T·∫£i tr·ªçng ƒë·ª©ng t√≠nh to√°n $N$ (kN):</label>
                <input type="number" id="inputN" value="500">
            </div>
            <div style="display: flex; gap: 15px;">
                <div class="input-group" style="flex: 1;">
                    <label>Chi·ªÅu r·ªông $B$ (m):</label>
                    <input type="number" id="inputB" value="1.5" step="0.1">
                </div>
                <div class="input-group" style="flex: 1;">
                    <label>Chi·ªÅu d√†i $L$ (m):</label>
                    <input type="number" id="inputL" value="2.0" step="0.1">
                </div>
            </div>

            <div class="nav-buttons">
                <button class="btn-outline" onclick="chuyenBuoc(2)">&larr; Quay l·∫°i</button>
                <button class="btn-primary" onclick="chuyenBuoc(4)">Ti·∫øp theo &rarr;</button>
            </div>
        </div>

        <div id="step-4" class="step-section">
            <h3>4. Ki·ªÉm tra s·ª©c ch·ªãu t·∫£i c·ªßa n·ªÅn</h3>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">H·ªá th·ªëng s·∫Ω ti·∫øn h√†nh ƒë·ªëi chi·∫øu √°p l·ª±c d∆∞·ªõi ƒë√°y m√≥ng v·ªõi s·ª©c ch·ªãu t·∫£i c·ªßa n·ªÅn ƒë·∫•t.</p>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn-primary btn-success" onclick="tinhToanMong()">Ti·∫øn h√†nh T√≠nh to√°n</button>
            </div>

            <div id="calc-result"></div>

            <div class="nav-buttons">
                <button class="btn-outline" onclick="chuyenBuoc(3)">&larr; Quay l·∫°i</button>
                <button class="btn-primary" onclick="alert('T√≠nh nƒÉng xu·∫•t PDF s·∫Ω ra m·∫Øt s·ªõm!')">Xu·∫•t PDF B√°o c√°o</button>
            </div>
        </div>

    </div>

    <script>
        // --- 1. LOGIC ƒêI·ªÄU H∆Ø·ªöNG GA T√ÄU ---
        function chuyenBuoc(step) {
            // X√≥a class active c·ªßa t·∫•t c·∫£ n·ªôi dung v√† sidebar
            document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.timeline li').forEach(el => el.classList.remove('active'));
            
            // K√≠ch ho·∫°t b∆∞·ªõc ƒë∆∞·ª£c ch·ªçn
            document.getElementById('step-' + step).classList.add('active');
            document.getElementById('nav-step-' + step).classList.add('active');

            // C·∫≠p nh·∫≠t l·∫°i MathJax n·∫øu c√≥ c√¥ng th·ª©c b·ªã ·∫©n
            if (window.MathJax) { MathJax.typesetPromise(); }
        }

        // --- 2. LOGIC TRA C·ª®U ƒê·ªäA CH·∫§T ---
        const SUPABASE_URL = "https://ezksahbyqwnbaabulhhd.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_o1TDH7-ji0GCdebRKzgUIA__fzNTGX1"; 
        let currentSoilData = null; 
        let mySoilChart = null; 

        async function traCuu() {
            const input = document.getElementById('maDeInput').value.trim();
            const resultDiv = document.getElementById('result');
            const profileContainer = document.getElementById('soil-profile-container');
            const btnNext = document.getElementById('btn-next-1');
            
            if (!input) { alert("Vui l√≤ng nh·∫≠p m√£ ƒë·ªÅ!"); return; }
            
            resultDiv.innerHTML = "<p>ƒêang t·∫£i d·ªØ li·ªáu...</p>";

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/ShallowFoundationCode?SFcode=eq.${input}`, {
                    headers: {
                        "apikey": SUPABASE_KEY,
                        "Authorization": `Bearer ${SUPABASE_KEY}`
                    }
                });
                const data = await response.json();

                if (data.length > 0) {
                    currentSoilData = data[0];
                    
                    // Hi·ªÉn th·ªã text
                    resultDiv.innerHTML = `
                        <div class="success">
                            <b style="color: #2f855a;">‚úÖ ƒê√£ l·∫•y d·ªØ li·ªáu m√£ ƒë·ªÅ: ${currentSoilData.SFcode}</b>
                            <p style="margin: 5px 0 0 0;"><b>ƒê·ªãa t·∫ßng:</b> ${currentSoilData.L1name} d√†y ${currentSoilData.L1thickn}m, ph√≠a d∆∞·ªõi l√† ${currentSoilData.L2name}.</p>
                        </div>
                    `;

                    // V·∫Ω bi·ªÉu ƒë·ªì
                    profileContainer.style.display = "block";
                    setTimeout(() => {
                        veTruDiaChat(currentSoilData.L1thickn, currentSoilData.L2thickn, currentSoilData.L1name, currentSoilData.L2name);
                    }, 100);

                    // M·ªü kh√≥a n√∫t Ti·∫øp theo
                    btnNext.disabled = false;
                } else {
                    resultDiv.innerHTML = "<div class="error">Kh√¥ng t√¨m th·∫•y m√£ ƒë·ªÅ n√†y!</div>";
                    profileContainer.style.display = "none";
                    btnNext.disabled = true;
                }
            } catch (error) {
                console.error(error);
                resultDiv.innerHTML = "<div class="error">L·ªói k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu!</div>";
            }
        }

        // --- 3. LOGIC V·∫º BI·ªÇU ƒê·ªí (Gi·ªØ nguy√™n) ---
        function veTruDiaChat(h1, h2, name1, name2) {
            const ctx = document.getElementById('soilChart').getContext('2d');
            if (mySoilChart) { mySoilChart.destroy(); }
            
            const depth1 = parseFloat(h1);
            const depth2 = parseFloat(h2);

            mySoilChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Tr·ª• ƒë·ªãa ch·∫•t'],
                    datasets: [
                        { label: `L·ªõp 1: ${name1}`, data: [depth1], backgroundColor: 'rgba(220, 185, 147, 0.9)', borderColor: '#8d6e63', borderWidth: 2, barPercentage: 0.6 },
                        { label: `L·ªõp 2: ${name2}`, data: [depth2], backgroundColor: 'rgba(230, 230, 200, 0.9)', borderColor: '#8d6e63', borderWidth: 2, barPercentage: 0.6 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        tooltip: {
                            callbacks: {
                                label: function(context) { return (context.dataset.label || '') + ': ' + context.parsed.y + 'm (ƒê·ªô d√†y)'; }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false }, border: { display: false }, ticks: { display: false } },
                        y: { stacked: true, reverse: true, beginAtZero: true, title: { display: true, text: 'ƒê·ªô s√¢u (m)' }, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        // --- 4. LOGIC T√çNH TO√ÅN (ƒê√£ t√≠ch h·ª£p MathJax render) ---
        function tinhToanMong() {
            if (!currentSoilData) {
                alert("‚ö†Ô∏è Vui l√≤ng quay l·∫°i B∆∞·ªõc 1 ƒë·ªÉ tra c·ª©u d·ªØ li·ªáu ƒë·ªãa ch·∫•t tr∆∞·ªõc!");
                chuyenBuoc(1);
                return;
            }

            const B = parseFloat(document.getElementById('inputB').value);
            const L = parseFloat(document.getElementById('inputL').value);
            const Df = parseFloat(document.getElementById('inputDf').value);
            const N = parseFloat(document.getElementById('inputN').value);

            const thicL1 = parseFloat(currentSoilData.L1thickn);

            let tenLopDatMong = "";
            let c = 0, phi = 0, gamma = 0; 

            if (Df <= thicL1) {
                tenLopDatMong = currentSoilData.L1name + " (L·ªõp 1)";
                c = currentSoilData.L1c || 15;       
                phi = currentSoilData.L1phi || 10;     
                gamma = currentSoilData.L1gamma || 18; 
            } else {
                tenLopDatMong = currentSoilData.L2name + " (L·ªõp 2)";
                c = currentSoilData.L2c || 20;       
                phi = currentSoilData.L2phi || 25;     
                gamma = currentSoilData.L2gamma || 19; 
            }

            const phiRad = phi * Math.PI / 180;
            const Nq = Math.exp(Math.PI * Math.tan(phiRad)) * Math.pow(Math.tan(Math.PI/4 + phiRad/2), 2);
            const Nc = (Nq - 1) / Math.tan(phiRad);
            const Ngamma = 2 * (Nq + 1) * Math.tan(phiRad);

            const q_ult = c * Nc * (1 + 0.3 * (B/L)) + gamma * Df * Nq + 0.5 * gamma * B * Ngamma * (1 - 0.2 * (B/L));
            const R_allowable = q_ult / 3;
            const P_actual = N / (B * L) + gamma * Df;

            const isSafe = P_actual <= R_allowable;
            const statusColor = isSafe ? "#28a745" : "#dc3545";
            const statusText = isSafe ? "ƒê·∫†T (N·ªÅn ƒë·∫•t ƒë·∫£m b·∫£o)" : "KH√îNG ƒê·∫†T (C·∫ßn tƒÉng k√≠ch th∆∞·ªõc B, L)";

            const resultDiv = document.getElementById('calc-result');
            resultDiv.innerHTML = `
                <div style="background: #fff; padding: 25px; border-radius: 8px; border: 1px solid #ddd; margin-top: 20px;">
                    <h4 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">üìä B√°o c√°o k·∫øt qu·∫£</h4>
                    <p><b>L·ªõp ƒë·∫•t t·ª±a m√≥ng:</b> ${tenLopDatMong}</p>
                    <p style="color: #666; font-size: 0.9em;">Th√¥ng s·ªë: $c = ${c}$ kPa, $\\phi = ${phi}^\\circ$, $\\gamma = ${gamma}$ kN/m¬≥</p>
                    
                    <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border: 1px solid #ddd;">√Åp l·ª±c c·ª±c h·∫°n ($q_{ult}$)</td>
                            <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; text-align: right;">${q_ult.toFixed(1)} kPa</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px; border: 1px solid #ddd;">S·ª©c ch·ªãu t·∫£i cho ph√©p ($R$)</td>
                            <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #0070f3; text-align: right;">${R_allowable.toFixed(1)} kPa</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border: 1px solid #ddd;">√Åp l·ª±c th·ª±c t·∫ø ($P$)</td>
                            <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; text-align: right;">${P_actual.toFixed(1)} kPa</td>
                        </tr>
                    </table>

                    <div style="margin-top: 20px; padding: 15px; border-radius: 5px; background: ${isSafe ? '#e6ffed' : '#fff1f0'}; border: 1px solid ${statusColor}; text-align: center; font-weight: bold; color: ${statusColor};">
                        K·∫øt lu·∫≠n: ${statusText}
                    </div>
                </div>
            `;
            
            // Y√™u c·∫ßu MathJax render l·∫°i c√¥ng th·ª©c
            if (window.MathJax) {
                MathJax.typesetPromise([resultDiv]).catch(err => console.error(err));
            }
        }
    </script>
</body>
</html>