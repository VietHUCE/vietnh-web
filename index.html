<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra cứu Mã đề - VietNH Startup</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background-color: #f4f4f9; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block; }
        input { padding: 10px; width: 250px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        button { padding: 10px 20px; background-color: #0070f3; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0051bb; }
        #result { margin-top: 20px; padding: 15px; border-radius: 5px; min-height: 20px; }
        .success { color: #28a745; background: #e6ffed; border: 1px solid #b7eb8f; }
        .error { color: #dc3545; background: #fff1f0; border: 1px solid #ffa39e; }
    </style>
</head>
<body>

<div class="container">
    <h2>Trợ lý Thiết kế Móng Đơn</h2>
    
    <div class="step-box">
        <h3>1. Tra cứu địa chất</h3>
        <input type="text" id="maDeInput" placeholder="Nhập mã đề (VD: 2)...">
        <button onclick="traCuu()">Lấy dữ liệu</button>
    </div>

    <div id="result"></div>

    <div id="design-section" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #ccc;">
        <h3>2. Thông số thiết kế móng</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; margin-bottom: 20px;">
            <div>
                <label>Chiều rộng B (m):</label>
                <input type="number" id="inputB" value="1.5" step="0.1" style="width: 90%;">
            </div>
            <div>
                <label>Chiều dài L (m):</label>
                <input type="number" id="inputL" value="2.0" step="0.1" style="width: 90%;">
            </div>
            <div>
                <label>Độ sâu chôn móng Df (m):</label>
                <input type="number" id="inputDf" value="1.5" step="0.1" style="width: 90%;">
            </div>
            <div>
                <label>Tải trọng đứng N (kN):</label>
                <input type="number" id="inputN" value="500" style="width: 90%;">
            </div>
        </div>
        <button onclick="tinhToanMong()" style="background-color: #28a745;">Tính toán sức chịu tải</button>
    </div>

    <div id="calc-result"></div>
</div>

<script>
    const SUPABASE_URL = "https://ezksahbyqwnbaabulhhd.supabase.co"; // URL của bạn
    const SUPABASE_KEY = "sb_publishable_o1TDH7-ji0GCdebRKzgUIA__fzNTGX1"; // API Key của bạn

    let currentSoilData = null; // Lưu trữ để dùng cho tính toán móng

    async function traCuu() {
        const input = document.getElementById('maDeInput').value.trim();
        const resultDiv = document.getElementById('result');
        const designSection = document.getElementById('design-section');
        
        if (!input) { alert("Vui lòng nhập mã đề!"); return; }

        try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/ShallowFoundationCode?SFcode=eq.${input}`, {
                headers: {
                    "apikey": SUPABASE_KEY,
                    "Authorization": `Bearer ${SUPABASE_KEY}`
                }
            });
            const data = await response.json();

            if (data.length > 0) {
                currentSoilData = data[0];
                
                // 1. Hiển thị thông tin văn bản
                resultDiv.innerHTML = `
                    <div style="background-color: #f0fff4; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #c6f6d5; text-align: left;">
                        <b style="color: #2f855a;">✅ Đã lấy dữ liệu mã đề: ${currentSoilData.SFcode}</b>
                        <p style="margin: 5px 0;"><b>Địa tầng:</b> ${currentSoilData.L1name} dày ${currentSoilData.L1thickn}m, phía dưới là ${currentSoilData.L2name}.</p>
                    </div>
                    <div id="soil-profile-area" style="margin-top: 20px;">
                        <h4>Hình ảnh trụ địa chất</h4>
                        <canvas id="soilCanvas" width="200" height="400" style="border: 1px solid #ccc; background: #fff; border-radius: 4px;"></canvas>
                        <div id="soil-legend" style="margin-top: 10px; font-size: 1.2em; font-weight: bold;"></div>
                    </div>
                `;

                // 2. Vẽ trụ địa chất (Sử dụng setTimeout để đảm bảo Canvas đã tồn tại trong DOM)
                setTimeout(() => {
                    veTruDiaChat(
                        currentSoilData.L1thickn, 
                        currentSoilData.L2thickn, 
                        currentSoilData.L1name, 
                        currentSoilData.L2name
                    );
                }, 100);
                
                // 3. Hiện phần thiết kế móng
                designSection.style.display = "block"; 
                designSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                resultDiv.innerHTML = "<p class='error'>Không tìm thấy mã đề này!</p>";
            }
        } catch (error) {
            console.error(error);
            resultDiv.innerHTML = "<p class='error'>Lỗi kết nối database!</p>";
        }
    }

    function veTruDiaChat(h1, h2, name1, name2) {
        const canvas = document.getElementById('soilCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const scale = 60; // 1m = 40px
        const startY = 30;
        const width = 80;
        const x = (canvas.width - width) / 2;

        // Lớp 1
        const pixelH1 = h1 * scale;
        ctx.fillStyle = "#e3d5b8"; 
        ctx.fillRect(x, startY, width, pixelH1);
        ctx.strokeStyle = "#8d6e63";
        ctx.lineWidth = 2;
        ctx.strokeRect(x, startY, width, pixelH1);
        
        // Ghi chú lớp 1
        ctx.fillStyle = "#333";
        ctx.font = "12px Arial";
        ctx.textAlign = "left";
        ctx.fillText(`${h1}m`, x + width + 10, startY + pixelH1/2);

        // Lớp 2
        const pixelH2 = h2 * scale;
        ctx.fillStyle = "#c2c5aa"; 
        ctx.fillRect(x, startY + pixelH1, width, pixelH2);
        ctx.strokeRect(x, startY + pixelH1, width, pixelH2);
        
        // Ghi chú lớp 2
        ctx.fillText(`${h2}m`, x + width + 10, startY + pixelH1 + pixelH2/2);

        // Đường mực nước tĩnh (Minh họa thêm cho chuyên nghiệp)
        ctx.setLineDash([5, 3]);
        ctx.beginPath();
        ctx.moveTo(x - 20, startY);
        ctx.lineTo(x + width + 20, startY);
        ctx.stroke();
        ctx.fillText("Mặt đất", x - 60, startY);

        document.getElementById('soil-legend').innerHTML = `
            <span style="color:#e3d5b8">■</span> ${name1} <br>
            <span style="color:#c2c5aa">■</span> ${name2}
        `;
    }

    function tinhToanMong() {
        // Hàm này sẽ dùng dữ liệu trong currentSoilData và các input B, L, Df để tính toán
        alert("Hệ thống đã sẵn sàng tính toán với dữ liệu mã đề " + currentSoilData.SFcode);
    }
</script>

</body>
</html>