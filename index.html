<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u M√£ ƒë·ªÅ - VietNH Startup</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background-color: #f4f4f9; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block; }
        input { padding: 10px; width: 250px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        button { padding: 10px 20px; background-color: #0070f3; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0051bb; }
        #result { margin-top: 20px; padding: 15px; border-radius: 5px; min-height: 20px; }
        .success { color: #28a745; background: #e6ffed; border: 1px solid #b7eb8f; }
        .error { color: #dc3545; background: #fff1f0; border: 1px solid #ffa39e; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="container">
        <h2>Tr·ª£ l√Ω Thi·∫øt k·∫ø M√≥ng ƒê∆°n</h2>
        
        <div class="step-box">
            <h3>1. Tra c·ª©u ƒë·ªãa ch·∫•t</h3>
            <input type="text" id="maDeInput" placeholder="Nh·∫≠p m√£ ƒë·ªÅ (VD: 2)...">
            <button onclick="traCuu()">L·∫•y d·ªØ li·ªáu</button>
        </div>

        <div id="result"></div> 

        <div id="soil-profile-container" style="display:none; margin-top: 30px; text-align: center;">
            <h4 style="margin-bottom: 15px;">H√¨nh ·∫£nh tr·ª• ƒë·ªãa ch·∫•t t∆∞∆°ng t√°c</h4>
            <div style="width: 350px; height: 500px; margin: 0 auto;">
                <canvas id="soilChart"></canvas>
            </div>
            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">* Di chuy·ªÉn chu·ªôt v√†o c√°c l·ªõp ƒë·∫•t ƒë·ªÉ xem chi ti·∫øt.</p>
        </div>

        <div id="design-section" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #ccc;">
            <h3>2. Th√¥ng s·ªë thi·∫øt k·∫ø m√≥ng</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; margin-bottom: 20px;">
                <div>
                    <label>Chi·ªÅu r·ªông B (m):</label>
                    <input type="number" id="inputB" value="1.5" step="0.1" style="width: 90%;">
                </div>
                <div>
                    <label>Chi·ªÅu d√†i L (m):</label>
                    <input type="number" id="inputL" value="2.0" step="0.1" style="width: 90%;">
                </div>
                <div>
                    <label>ƒê·ªô s√¢u ch√¥n m√≥ng Df (m):</label>
                    <input type="number" id="inputDf" value="1.5" step="0.1" style="width: 90%;">
                </div>
                <div>
                    <label>T·∫£i tr·ªçng ƒë·ª©ng N (kN):</label>
                    <input type="number" id="inputN" value="500" style="width: 90%;">
                </div>
            </div>
            <button onclick="tinhToanMong()" style="background-color: #28a745;">T√≠nh to√°n s·ª©c ch·ªãu t·∫£i</button>
        </div>

        <div id="calc-result"></div>
    </div>

    <script>
        const SUPABASE_URL = "https://ezksahbyqwnbaabulhhd.supabase.co"; // URL c·ªßa b·∫°n
        const SUPABASE_KEY = "sb_publishable_o1TDH7-ji0GCdebRKzgUIA__fzNTGX1"; // API Key c·ªßa b·∫°n

        let currentSoilData = null; // L∆∞u tr·ªØ ƒë·ªÉ d√πng cho t√≠nh to√°n m√≥ng

        async function traCuu() {
            const input = document.getElementById('maDeInput').value.trim();
            // 1. S·ª¨A: L·∫•y ƒë√∫ng th·∫ª result ƒë·ªÉ in ch·ªØ
            const resultDiv = document.getElementById('result'); 
            // 2. S·ª¨A: L·∫•y ri√™ng th·∫ª container c·ªßa bi·ªÉu ƒë·ªì
            const profileContainer = document.getElementById('soil-profile-container'); 
            const designSection = document.getElementById('design-section');
            
            if (!input) { alert("Vui l√≤ng nh·∫≠p m√£ ƒë·ªÅ!"); return; }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/ShallowFoundationCode?SFcode=eq.${input}`, {
                    headers: {
                        "apikey": SUPABASE_KEY,
                        "Authorization": `Bearer ${SUPABASE_KEY}`
                    }
                });
                const data = await response.json();

                if (data.length > 0) {
                    currentSoilData = data[0];
                    
                    // 3. S·ª¨A: Ch·ªâ in kh·ªëi th√¥ng b√°o vƒÉn b·∫£n v√†o resultDiv, KH√îNG in th·∫ª canvas c≈© v√†o ƒë√¢y n·ªØa
                    resultDiv.innerHTML = `
                        <div style="background-color: #f0fff4; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #c6f6d5; text-align: left;">
                            <b style="color: #2f855a;">‚úÖ ƒê√£ l·∫•y d·ªØ li·ªáu m√£ ƒë·ªÅ: ${currentSoilData.SFcode}</b>
                            <p style="margin: 5px 0;"><b>ƒê·ªãa t·∫ßng:</b> ${currentSoilData.L1name} d√†y ${currentSoilData.L1thickn}m, ph√≠a d∆∞·ªõi l√† ${currentSoilData.L2name}.</p>
                        </div>
                    `;

                    // 4. M·ªöI: B·∫≠t hi·ªÉn th·ªã cho khung ch·ª©a Chart.js
                    profileContainer.style.display = "block";

                    // V·∫Ω tr·ª• ƒë·ªãa ch·∫•t b·∫±ng Chart.js
                    setTimeout(() => {
                        veTruDiaChat(
                            currentSoilData.L1thickn, 
                            currentSoilData.L2thickn, 
                            currentSoilData.L1name, 
                            currentSoilData.L2name
                        );
                    }, 100);
                    
                    // Hi·ªán ph·∫ßn thi·∫øt k·∫ø m√≥ng
                    designSection.style.display = "block"; 
                    designSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    resultDiv.innerHTML = "<p class='error'>Kh√¥ng t√¨m th·∫•y m√£ ƒë·ªÅ n√†y!</p>";
                    profileContainer.style.display = "none";
                    designSection.style.display = "none";
                }
            } catch (error) {
                console.error(error);
                resultDiv.innerHTML = "<p class='error'>L·ªói k·∫øt n·ªëi database!</p>";
            }
        }

        let mySoilChart = null; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ ƒë·ªëi t∆∞·ª£ng bi·ªÉu ƒë·ªì

        function veTruDiaChat(h1, h2, name1, name2) {
            const ctx = document.getElementById('soilChart').getContext('2d');

            // N·∫øu ƒë√£ c√≥ bi·ªÉu ƒë·ªì c≈© th√¨ h·ªßy n√≥ ƒëi tr∆∞·ªõc khi v·∫Ω c√°i m·ªõi ƒë·ªÉ tr√°nh l·ªói ch·ªìng l·∫•n
            if (mySoilChart) {
                mySoilChart.destroy();
            }

            // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu ƒë·ªô d√†y sang s·ªë th·ª±c
            const depth1 = parseFloat(h1);
            const depth2 = parseFloat(h2);

            // C·∫•u h√¨nh d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì
            const data = {
                labels: ['Tr·ª• ƒë·ªãa ch·∫•t'], // Nh√£n cho c·ªôt duy nh·∫•t
                datasets: [
                    {
                        label: `L·ªõp 1: ${name1}`, // T√™n hi·ªÉn th·ªã trong ch√∫ gi·∫£i v√† tooltip
                        data: [depth1], // ƒê·ªô d√†y l·ªõp 1
                        backgroundColor: 'rgba(220, 185, 147, 0.9)', // M√†u s·∫Øc n√©t, chuy√™n nghi·ªáp (S√©t)
                        borderColor: '#8d6e63',
                        borderWidth: 2,
                        barPercentage: 0.6, // ƒê·ªô r·ªông c·ªßa c·ªôt
                    },
                    {
                        label: `L·ªõp 2: ${name2}`,
                        data: [depth2], // ƒê·ªô d√†y l·ªõp 2
                        backgroundColor: 'rgba(230, 230, 200, 0.9)', // M√†u s·∫Øc n√©t (C√°t)
                        borderColor: '#8d6e63',
                        borderWidth: 2,
                        barPercentage: 0.6,
                    }
                ]
            };

            // C·∫•u h√¨nh c√°c t√πy ch·ªçn ƒë·ªÉ bi·ªÉu ƒë·ªì tr√¥ng gi·ªëng tr·ª• ƒë·ªãa ch·∫•t
            const options = {
                responsive: true,
                maintainAspectRatio: false, // Cho ph√©p thay ƒë·ªïi t·ª∑ l·ªá theo container
                plugins: {
                    // C·∫•u h√¨nh ch√∫ gi·∫£i (Legend)
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 14 },
                            padding: 20
                        }
                    },
                    // C·∫•u h√¨nh Tooltip (T∆∞∆°ng t√°c khi di chu·ªôt) - Y h·ªát ClearCalcs!
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 16, weight: 'bold' },
                        bodyFont: { size: 14 },
                        padding: 12,
                        cornerRadius: 4,
                        callbacks: {
                            // T√πy ch·ªânh n·ªôi dung hi·ªÉn th·ªã trong tooltip
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y + 'm (ƒê·ªô d√†y)';
                                }
                                return label;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'M√¥ h√¨nh H·ªë khoan',
                        font: { size: 18, weight: 'bold' },
                        padding: { bottom: 20 }
                    }
                },
                scales: {
                    // C·∫•u h√¨nh tr·ª•c X (Tr·ª•c ngang) - ·∫®n ƒëi ƒë·ªÉ tr√¥ng gi·ªëng c·ªôt ƒë·∫•t
                    x: {
                        stacked: true, // Quan tr·ªçng: Ch·ªìng c√°c l·ªõp l√™n nhau
                        grid: { display: false }, // ·∫®n l∆∞·ªõi
                        border: { display: false }, // ·∫®n ƒë∆∞·ªùng tr·ª•c
                        ticks: { display: false } // ·∫®n nh√£n
                    },
                    // C·∫•u h√¨nh tr·ª•c Y (Tr·ª•c ƒë·ª©ng - ƒê·ªô s√¢u)
                    y: {
                        stacked: true, // Quan tr·ªçng: Ch·ªìng c√°c l·ªõp l√™n nhau
                        reverse: true, // QUAN TR·ªåNG NH·∫§T: ƒê·∫£o ng∆∞·ª£c tr·ª•c ƒë·ªÉ 0m ·ªü tr√™n ƒë·ªânh
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'ƒê·ªô s√¢u (m)',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            font: { size: 12 },
                            stepSize: 1 // Hi·ªÉn th·ªã v·∫°ch chia m·ªói 1m
                        },
                        grid: {
                            color: '#e0e0e0' // M√†u l∆∞·ªõi m·ªù nh·∫°t chuy√™n nghi·ªáp
                        }
                    }
                }
            };

            // T·∫°o bi·ªÉu ƒë·ªì m·ªõi
            mySoilChart = new Chart(ctx, {
                type: 'bar', // Lo·∫°i bi·ªÉu ƒë·ªì c·ªôt
                data: data,
                options: options
            });
        }

        function tinhToanMong() {
            // Ki·ªÉm tra xem ƒë√£ tra c·ª©u d·ªØ li·ªáu ch∆∞a
            if (!currentSoilData) {
                alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p m√£ ƒë·ªÅ v√† tra c·ª©u d·ªØ li·ªáu ƒë·ªãa ch·∫•t tr∆∞·ªõc khi t√≠nh to√°n!");
                return;
            }

            // 1. L·∫•y th√¥ng s·ªë t·ª´ giao di·ªán nh·∫≠p li·ªáu
            const B = parseFloat(document.getElementById('inputB').value);
            const L = parseFloat(document.getElementById('inputL').value);
            const Df = parseFloat(document.getElementById('inputDf').value);
            const N = parseFloat(document.getElementById('inputN').value); // T·∫£i tr·ªçng ƒë·ª©ng

            const thicL1 = parseFloat(currentSoilData.L1thickn);

            // 2. X√°c ƒë·ªãnh l·ªõp ƒë·∫•t ƒë·∫∑t m√≥ng d·ª±a v√†o Df
            let tenLopDatMong = "";
            // L∆ØU √ù: Gi·∫£ ƒë·ªãnh c√°c bi·∫øn c, phi, gamma l·∫•y t·ª´ Database. 
            // B·∫°n c·∫ßn thay th·∫ø L1c, L1phi... b·∫±ng ƒë√∫ng t√™n c·ªôt trong b·∫£ng Supabase c·ªßa b·∫°n
            let c = 0, phi = 0, gamma = 0; 

            if (Df <= thicL1) {
                tenLopDatMong = currentSoilData.L1name + " (L·ªõp 1)";
                c = currentSoilData.L1c || 15;       // L·ª±c d√≠nh (kPa) - ƒêang ƒë·ªÉ s·ªë gi·∫£ ƒë·ªãnh n·∫øu DB ch∆∞a c√≥
                phi = currentSoilData.L1phi || 10;     // G√≥c ma s√°t (ƒë·ªô)
                gamma = currentSoilData.L1gamma || 18; // Tr·ªçng l∆∞·ª£ng ri√™ng (kN/m3)
            } else {
                tenLopDatMong = currentSoilData.L2name + " (L·ªõp 2)";
                c = currentSoilData.L2c || 20;       
                phi = currentSoilData.L2phi || 25;     
                gamma = currentSoilData.L2gamma || 19; 
            }

            // 3. T√≠nh to√°n s·ª©c ch·ªãu t·∫£i (M√¥ ph·ªèng c√¥ng th·ª©c Terzaghi / TCVN)
            // Chuy·ªÉn g√≥c ma s√°t sang radian ƒë·ªÉ t√≠nh sin, cos
            const phiRad = phi * Math.PI / 180;
            
            // T√≠nh c√°c h·ªá s·ªë s·ª©c ch·ªãu t·∫£i (C√¥ng th·ª©c g·∫ßn ƒë√∫ng)
            const Nq = Math.exp(Math.PI * Math.tan(phiRad)) * Math.pow(Math.tan(Math.PI/4 + phiRad/2), 2);
            const Nc = (Nq - 1) / Math.tan(phiRad);
            const Ngamma = 2 * (Nq + 1) * Math.tan(phiRad);

            // C√¥ng th·ª©c t√≠nh s·ª©c ch·ªãu t·∫£i c·ª±c h·∫°n (q_ult) cho m√≥ng ch·ªØ nh·∫≠t
            const q_ult = c * Nc * (1 + 0.3 * (B/L)) + gamma * Df * Nq + 0.5 * gamma * B * Ngamma * (1 - 0.2 * (B/L));
            
            // S·ª©c ch·ªãu t·∫£i cho ph√©p (R) - H·ªá s·ªë an to√†n Fs = 3
            const Fs = 3;
            const R_allowable = q_ult / Fs;

            // √Åp l·ª±c th·ª±c t·∫ø d∆∞·ªõi ƒë√°y m√≥ng (P)
            const DienTich = B * L;
            const P_actual = N / DienTich + gamma * Df;

            // ƒê√°nh gi√° an to√†n
            const isSafe = P_actual <= R_allowable;
            const statusColor = isSafe ? "#28a745" : "#dc3545";
            const statusText = isSafe ? "ƒê·∫†T (An to√†n)" : "KH√îNG ƒê·∫†T (C·∫ßn tƒÉng k√≠ch th∆∞·ªõc B, L)";

            // 4. Hi·ªÉn th·ªã k·∫øt qu·∫£ ra giao di·ªán
            const resultDiv = document.getElementById('calc-result');
            resultDiv.innerHTML = `
                <div style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-top: 25px; text-align: left;">
                    <h3 style="margin-top:0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px;">üìä B√°o c√°o Thi·∫øt k·∫ø M√≥ng</h3>
                    
                    <p><b>1. L·ªõp ƒë·∫•t ƒë·∫∑t m√≥ng:</b> ${tenLopDatMong}</p>
                    <p style="color: #555; font-size: 0.9em;"><i>Th√¥ng s·ªë t·ª± ƒë·ªông l·∫•y t·ª´ DB: $c$ = ${c} kPa, $\\phi$ = ${phi}¬∞, $\\gamma$ = ${gamma} kN/m¬≥</i></p>
                    
                    <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 10px; border: 1px solid #ddd;">√Åp l·ª±c c·ª±c h·∫°n n·ªÅn ƒë·∫•t ($q_{ult}$)</td>
                            <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${q_ult.toFixed(1)} kPa</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">S·ª©c ch·ªãu t·∫£i cho ph√©p ($R$)</td>
                            <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold; color: #007bff;">${R_allowable.toFixed(1)} kPa</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 10px; border: 1px solid #ddd;">√Åp l·ª±c th·ª±c t·∫ø d∆∞·ªõi ƒë√°y m√≥ng ($P$)</td>
                            <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${P_actual.toFixed(1)} kPa</td>
                        </tr>
                    </table>

                    <div style="margin-top: 20px; padding: 15px; border-radius: 5px; background: ${isSafe ? '#e6ffed' : '#fff1f0'}; border: 1px solid ${statusColor}; text-align: center;">
                        <h4 style="margin: 0; color: ${statusColor};">K·∫øt lu·∫≠n: ${statusText}</h4>
                    </div>
                </div>
            `;
            
            // Cu·ªôn xu·ªëng xem k·∫øt qu·∫£
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>

</body>
</html>