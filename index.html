<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra cứu Mã đề - VietNH Startup</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background-color: #f4f4f9; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block; }
        input { padding: 10px; width: 250px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        button { padding: 10px 20px; background-color: #0070f3; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0051bb; }
        #result { margin-top: 20px; padding: 15px; border-radius: 5px; min-height: 20px; }
        .success { color: #28a745; background: #e6ffed; border: 1px solid #b7eb8f; }
        .error { color: #dc3545; background: #fff1f0; border: 1px solid #ffa39e; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="container">
        <h2>Trợ lý Thiết kế Móng Đơn</h2>
        
        <div class="step-box">
            <h3>1. Tra cứu địa chất</h3>
            <input type="text" id="maDeInput" placeholder="Nhập mã đề (VD: 2)...">
            <button onclick="traCuu()">Lấy dữ liệu</button>
        </div>

        <div id="result"></div> 

        <div id="soil-profile-container" style="display:none; margin-top: 30px; text-align: center;">
            <h4 style="margin-bottom: 15px;">Hình ảnh trụ địa chất tương tác</h4>
            <div style="width: 350px; height: 500px; margin: 0 auto;">
                <canvas id="soilChart"></canvas>
            </div>
            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">* Di chuyển chuột vào các lớp đất để xem chi tiết.</p>
        </div>

        <div id="design-section" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #ccc;">
            <h3>2. Thông số thiết kế móng</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; margin-bottom: 20px;">
                <div>
                    <label>Chiều rộng B (m):</label>
                    <input type="number" id="inputB" value="1.5" step="0.1" style="width: 90%;">
                </div>
                <div>
                    <label>Chiều dài L (m):</label>
                    <input type="number" id="inputL" value="2.0" step="0.1" style="width: 90%;">
                </div>
                <div>
                    <label>Độ sâu chôn móng Df (m):</label>
                    <input type="number" id="inputDf" value="1.5" step="0.1" style="width: 90%;">
                </div>
                <div>
                    <label>Tải trọng đứng N (kN):</label>
                    <input type="number" id="inputN" value="500" style="width: 90%;">
                </div>
            </div>
            <button onclick="tinhToanMong()" style="background-color: #28a745;">Tính toán sức chịu tải</button>
        </div>

        <div id="calc-result"></div>
    </div>

    <script>
        const SUPABASE_URL = "https://ezksahbyqwnbaabulhhd.supabase.co"; // URL của bạn
        const SUPABASE_KEY = "sb_publishable_o1TDH7-ji0GCdebRKzgUIA__fzNTGX1"; // API Key của bạn

        let currentSoilData = null; // Lưu trữ để dùng cho tính toán móng

        async function traCuu() {
            const input = document.getElementById('maDeInput').value.trim();
            // 1. SỬA: Lấy đúng thẻ result để in chữ
            const resultDiv = document.getElementById('result'); 
            // 2. SỬA: Lấy riêng thẻ container của biểu đồ
            const profileContainer = document.getElementById('soil-profile-container'); 
            const designSection = document.getElementById('design-section');
            
            if (!input) { alert("Vui lòng nhập mã đề!"); return; }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/ShallowFoundationCode?SFcode=eq.${input}`, {
                    headers: {
                        "apikey": SUPABASE_KEY,
                        "Authorization": `Bearer ${SUPABASE_KEY}`
                    }
                });
                const data = await response.json();

                if (data.length > 0) {
                    currentSoilData = data[0];
                    
                    // 3. SỬA: Chỉ in khối thông báo văn bản vào resultDiv, KHÔNG in thẻ canvas cũ vào đây nữa
                    resultDiv.innerHTML = `
                        <div style="background-color: #f0fff4; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #c6f6d5; text-align: left;">
                            <b style="color: #2f855a;">✅ Đã lấy dữ liệu mã đề: ${currentSoilData.SFcode}</b>
                            <p style="margin: 5px 0;"><b>Địa tầng:</b> ${currentSoilData.L1name} dày ${currentSoilData.L1thickn}m, phía dưới là ${currentSoilData.L2name}.</p>
                        </div>
                    `;

                    // 4. MỚI: Bật hiển thị cho khung chứa Chart.js
                    profileContainer.style.display = "block";

                    // Vẽ trụ địa chất bằng Chart.js
                    setTimeout(() => {
                        veTruDiaChat(
                            currentSoilData.L1thickn, 
                            currentSoilData.L2thickn, 
                            currentSoilData.L1name, 
                            currentSoilData.L2name
                        );
                    }, 100);
                    
                    // Hiện phần thiết kế móng
                    designSection.style.display = "block"; 
                    designSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    resultDiv.innerHTML = "<p class='error'>Không tìm thấy mã đề này!</p>";
                    profileContainer.style.display = "none";
                    designSection.style.display = "none";
                }
            } catch (error) {
                console.error(error);
                resultDiv.innerHTML = "<p class='error'>Lỗi kết nối database!</p>";
            }
        }

        let mySoilChart = null; // Biến toàn cục để lưu trữ đối tượng biểu đồ

        function veTruDiaChat(h1, h2, name1, name2) {
            const ctx = document.getElementById('soilChart').getContext('2d');

            // Nếu đã có biểu đồ cũ thì hủy nó đi trước khi vẽ cái mới để tránh lỗi chồng lấn
            if (mySoilChart) {
                mySoilChart.destroy();
            }

            // Chuyển đổi dữ liệu độ dày sang số thực
            const depth1 = parseFloat(h1);
            const depth2 = parseFloat(h2);

            // Cấu hình dữ liệu cho biểu đồ
            const data = {
                labels: ['Trụ địa chất'], // Nhãn cho cột duy nhất
                datasets: [
                    {
                        label: `Lớp 1: ${name1}`, // Tên hiển thị trong chú giải và tooltip
                        data: [depth1], // Độ dày lớp 1
                        backgroundColor: 'rgba(220, 185, 147, 0.9)', // Màu sắc nét, chuyên nghiệp (Sét)
                        borderColor: '#8d6e63',
                        borderWidth: 2,
                        barPercentage: 0.6, // Độ rộng của cột
                    },
                    {
                        label: `Lớp 2: ${name2}`,
                        data: [depth2], // Độ dày lớp 2
                        backgroundColor: 'rgba(230, 230, 200, 0.9)', // Màu sắc nét (Cát)
                        borderColor: '#8d6e63',
                        borderWidth: 2,
                        barPercentage: 0.6,
                    }
                ]
            };

            // Cấu hình các tùy chọn để biểu đồ trông giống trụ địa chất
            const options = {
                responsive: true,
                maintainAspectRatio: false, // Cho phép thay đổi tỷ lệ theo container
                plugins: {
                    // Cấu hình chú giải (Legend)
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 14 },
                            padding: 20
                        }
                    },
                    // Cấu hình Tooltip (Tương tác khi di chuột) - Y hệt ClearCalcs!
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 16, weight: 'bold' },
                        bodyFont: { size: 14 },
                        padding: 12,
                        cornerRadius: 4,
                        callbacks: {
                            // Tùy chỉnh nội dung hiển thị trong tooltip
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y + 'm (Độ dày)';
                                }
                                return label;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Mô hình Hố khoan',
                        font: { size: 18, weight: 'bold' },
                        padding: { bottom: 20 }
                    }
                },
                scales: {
                    // Cấu hình trục X (Trục ngang) - Ẩn đi để trông giống cột đất
                    x: {
                        stacked: true, // Quan trọng: Chồng các lớp lên nhau
                        grid: { display: false }, // Ẩn lưới
                        border: { display: false }, // Ẩn đường trục
                        ticks: { display: false } // Ẩn nhãn
                    },
                    // Cấu hình trục Y (Trục đứng - Độ sâu)
                    y: {
                        stacked: true, // Quan trọng: Chồng các lớp lên nhau
                        reverse: true, // QUAN TRỌNG NHẤT: Đảo ngược trục để 0m ở trên đỉnh
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Độ sâu (m)',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            font: { size: 12 },
                            stepSize: 1 // Hiển thị vạch chia mỗi 1m
                        },
                        grid: {
                            color: '#e0e0e0' // Màu lưới mờ nhạt chuyên nghiệp
                        }
                    }
                }
            };

            // Tạo biểu đồ mới
            mySoilChart = new Chart(ctx, {
                type: 'bar', // Loại biểu đồ cột
                data: data,
                options: options
            });
        }

        function tinhToanMong() {
            // Hàm này sẽ dùng dữ liệu trong currentSoilData và các input B, L, Df để tính toán
            alert("Hệ thống đã sẵn sàng tính toán với dữ liệu mã đề " + currentSoilData.SFcode);
        }
    </script>

</body>
</html>