<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra cứu Mã đề - VietNH Startup</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background-color: #f4f4f9; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block; }
        input { padding: 10px; width: 250px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        button { padding: 10px 20px; background-color: #0070f3; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0051bb; }
        #result { margin-top: 20px; padding: 15px; border-radius: 5px; min-height: 20px; }
        .success { color: #28a745; background: #e6ffed; border: 1px solid #b7eb8f; }
        .error { color: #dc3545; background: #fff1f0; border: 1px solid #ffa39e; }
    </style>
</head>
<body>

<div class="container">
    <h2>Trợ lý Thiết kế Móng Đơn</h2>
    
    <div class="step-box">
        <h3>1. Tra cứu địa chất</h3>
        <input type="text" id="maDeInput" placeholder="Nhập mã đề (VD: 2)...">
        <button onclick="traCuu()">Lấy dữ liệu</button>
    </div>

    <div id="result"></div>

    <div id="design-section" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #ccc;">
        <h3>2. Thông số thiết kế móng</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; margin-bottom: 20px;">
            <div>
                <label>Chiều rộng B (m):</label>
                <input type="number" id="inputB" value="1.5" step="0.1" style="width: 90%;">
            </div>
            <div>
                <label>Chiều dài L (m):</label>
                <input type="number" id="inputL" value="2.0" step="0.1" style="width: 90%;">
            </div>
            <div>
                <label>Độ sâu chôn móng Df (m):</label>
                <input type="number" id="inputDf" value="1.5" step="0.1" style="width: 90%;">
            </div>
            <div>
                <label>Tải trọng đứng N (kN):</label>
                <input type="number" id="inputN" value="500" style="width: 90%;">
            </div>
        </div>
        <button onclick="tinhToanMong()" style="background-color: #28a745;">Tính toán sức chịu tải</button>
    </div>

    <div id="calc-result"></div>
</div>

<script>
    const SUPABASE_URL = "https://ezksahbyqwnbaabulhhd.supabase.co"; // URL của bạn
    const SUPABASE_KEY = "sb_publishable_o1TDH7-ji0GCdebRKzgUIA__fzNTGX1"; // API Key của bạn

    let currentSoilData = null; // Lưu trữ để dùng cho tính toán móng

    async function traCuu() {
        const input = document.getElementById('maDeInput').value.trim();
        const resultDiv = document.getElementById('result');
        const designSection = document.getElementById('design-section');
        
        if (!input) { alert("Vui lòng nhập mã đề!"); return; }

        try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/ShallowFoundationCode?SFcode=eq.${input}`, {
                headers: {
                    "apikey": SUPABASE_KEY,
                    "Authorization": `Bearer ${SUPABASE_KEY}`
                }
            });
            const data = await response.json();

            if (data.length > 0) {
                currentSoilData = data[0];
                
                // 1. Hiển thị thông tin văn bản
                resultDiv.innerHTML = `
                    <div style="background-color: #f0fff4; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #c6f6d5; text-align: left;">
                        <b style="color: #2f855a;">✅ Đã lấy dữ liệu mã đề: ${currentSoilData.SFcode}</b>
                        <p style="margin: 5px 0;"><b>Địa tầng:</b> ${currentSoilData.L1name} dày ${currentSoilData.L1thickn}m, phía dưới là ${currentSoilData.L2name}.</p>
                    </div>
                    <div id="soil-profile-area" style="margin-top: 20px;">
                        <h4>Hình ảnh trụ địa chất</h4>
                        <canvas id="soilCanvas" width="200" height="400" style="border: 1px solid #ccc; background: #fff; border-radius: 4px;"></canvas>
                        <div id="soil-legend" style="margin-top: 10px; font-size: 1.2em; font-weight: bold;"></div>
                    </div>
                `;

                // 2. Vẽ trụ địa chất (Sử dụng setTimeout để đảm bảo Canvas đã tồn tại trong DOM)
                setTimeout(() => {
                    veTruDiaChat(
                        currentSoilData.L1thickn, 
                        currentSoilData.L2thickn, 
                        currentSoilData.L1name, 
                        currentSoilData.L2name
                    );
                }, 100);
                
                // 3. Hiện phần thiết kế móng
                designSection.style.display = "block"; 
                designSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                resultDiv.innerHTML = "<p class='error'>Không tìm thấy mã đề này!</p>";
            }
        } catch (error) {
            console.error(error);
            resultDiv.innerHTML = "<p class='error'>Lỗi kết nối database!</p>";
        }
    }

    // --- HÀM VẼ TRỤ ĐỊA CHẤT NÂNG CẤP ---
    function veTruDiaChat(h1, h2, name1, name2) {
        const canvas = document.getElementById('soilCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        
        // 1. Thiết lập cơ bản
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = "12px Arial";
        ctx.textAlign = "center";

        // Chuyển đổi dữ liệu sang số thực để tính toán an toàn
        const depth1 = parseFloat(h1);
        const depth2 = parseFloat(h2);
        const totalDepth = depth1 + depth2;

        // Các thông số vẽ
        const topMargin = 40;   // Lề trên cho tiêu đề
        const leftMargin = 40;  // Lề trái cho thước đo
        const colWidth = 100;   // Chiều rộng cột trụ
        // Tự động tính tỷ lệ: Đảm bảo vẽ hết độ sâu trong khoảng 300px chiều cao
        let scale = 300 / totalDepth; 
        // Giới hạn tỷ lệ tối thiểu và tối đa để hình không quá bé hoặc quá lớn
        if (scale < 30) scale = 30;
        if (scale > 60) scale = 60;
        
        const startX = leftMargin;
        const startY = topMargin;

        // --- PHẦN 1: VẼ TIÊU ĐỀ & MẶT ĐẤT ---
        ctx.fillStyle = "#333";
        ctx.font = "bold 14px Arial";
        ctx.fillText("TRỤ ĐỊA CHẤT", canvas.width / 2, 20);
        
        // Vẽ đường mặt đất
        ctx.beginPath();
        ctx.moveTo(startX - 10, startY);
        ctx.lineTo(startX + colWidth + 20, startY);
        ctx.strokeStyle = "#555";
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.font = "11px Arial";
        ctx.textAlign = "right";
        ctx.fillText("Mặt đất (0.0m)", startX - 5, startY - 5);

        // --- PHẦN 2: VẼ CÁC LỚP ĐẤT ---
        ctx.textAlign = "left";
        ctx.lineWidth = 1;

        // Lớp 1
        const pixelH1 = depth1 * scale;
        // Sử dụng gradient nhẹ để tạo khối trông thật hơn
        let grd1 = ctx.createLinearGradient(startX, startY, startX + colWidth, startY);
        grd1.addColorStop(0, "#dcb993"); // Màu nâu vàng nhạt (Sét/Á sét)
        grd1.addColorStop(1, "#cbae85");
        ctx.fillStyle = grd1;
        ctx.fillRect(startX, startY, colWidth, pixelH1);
        ctx.strokeRect(startX, startY, colWidth, pixelH1);

        // Lớp 2
        const pixelH2 = depth2 * scale;
        let grd2 = ctx.createLinearGradient(startX, startY + pixelH1, startX + colWidth, startY + pixelH1);
        grd2.addColorStop(0, "#e6e6c8"); // Màu xám vàng (Cát/Á cát)
        grd2.addColorStop(1, "#d4d4b4");
        ctx.fillStyle = grd2;
        ctx.fillRect(startX, startY + pixelH1, colWidth, pixelH2);
        ctx.strokeRect(startX, startY + pixelH1, colWidth, pixelH2);

        // --- PHẦN 3: VẼ THƯỚC ĐO ĐỘ SÂU (RULER) ---
        ctx.strokeStyle = "#888";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(startX, startY + pixelH1 + pixelH2 + 20); // Trục dọc
        ctx.stroke();

        ctx.textAlign = "right";
        ctx.font = "10px Arial";
        ctx.fillStyle = "#555";

        // Vòng lặp vẽ vạch chia độ sâu (mỗi 0.5m một vạch nhỏ, 1m một vạch lớn)
        // Giới hạn vẽ thước đo đến độ sâu tối đa của hố khoan
        for (let d = 0.5; d <= Math.ceil(totalDepth); d += 0.5) {
            const yPos = startY + d * scale;
            // Chỉ vẽ nếu vạch nằm trong phạm vi cột đất
            if (d <= totalDepth + 0.1) {
                if (Number.isInteger(d)) {
                    // Vạch chẵn (1m, 2m...) - Vạch dài + số
                    ctx.beginPath(); ctx.moveTo(startX - 8, yPos); ctx.lineTo(startX, yPos); ctx.stroke();
                    ctx.fillText(d.toFixed(1) + "m", startX - 10, yPos + 3);
                } else {
                    // Vạch lẻ (0.5m, 1.5m...) - Vạch ngắn
                    ctx.beginPath(); ctx.moveTo(startX - 5, yPos); ctx.lineTo(startX, yPos); ctx.stroke();
                }
            }
        }

        // --- PHẦN 4: GHI CHÚ ĐỘ SÂU TẠI RANH GIỚI LỚP ---
        ctx.textAlign = "left";
        ctx.fillStyle = "#000";
        ctx.font = "bold 11px Arial";

        // Độ sâu đáy lớp 1
        ctx.fillText(`▼ ${depth1.toFixed(1)}m`, startX + colWidth + 5, startY + pixelH1 + 4);
        
        // Độ sâu đáy lớp 2 (Đáy hố khoan)
        ctx.fillText(`▼ ${(depth1 + depth2).toFixed(1)}m`, startX + colWidth + 5, startY + pixelH1 + pixelH2 + 4);

        // --- PHẦN 5: CẬP NHẬT CHÚ GIẢI (LEGEND) ---
        document.getElementById('soil-legend').innerHTML = `
            <div style="text-align:left; margin-top:10px; border-top:1px dotted #ccc; padding-top:5px;">
                <div style="margin-bottom:4px;"><span style="display:inline-block;width:12px;height:12px;background:#dcb993;border:1px solid #8d6e63;margin-right:5px;"></span><b>Lớp 1:</b> ${name1} (Dày ${depth1}m)</div>
                <div><span style="display:inline-block;width:12px;height:12px;background:#e6e6c8;border:1px solid #8d6e63;margin-right:5px;"></span><b>Lớp 2:</b> ${name2} (Dày ${depth2}m)</div>
            </div>
        `;
    }

    function tinhToanMong() {
        // Hàm này sẽ dùng dữ liệu trong currentSoilData và các input B, L, Df để tính toán
        alert("Hệ thống đã sẵn sàng tính toán với dữ liệu mã đề " + currentSoilData.SFcode);
    }
</script>

</body>
</html>